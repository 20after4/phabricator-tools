#!/usr/bin/env python
# encoding: utf-8

"""Arcyd automates the creation and landing of reviews from branches"""

import argparse
import platform
import sys
import traceback

import abdcmd_single
import abdcmd_multi
import phlmail_format
import phlsys_sendmail


def setupParser(name, module, subparsers):
    doc = module.__doc__
    docSubject = doc.splitlines()[0]
    docEpilog = '\n'.join(doc.splitlines()[1:])
    parser = subparsers.add_parser(
        name,
        formatter_class=argparse.RawDescriptionHelpFormatter,
        help=docSubject,
        description=docSubject,
        epilog=docEpilog,
        fromfile_prefix_chars=module.getFromfilePrefixChars())
    module.setupParser(parser)
    parser.set_defaults(func=module.process)


def main():
    description = str("""
Arcyd - an arcanist branch daemon

Intended to make it easy for large teams to start using Differential without
individual contributors needing to install and configure Arcanist.

Individual contributors are still free to use Arcanist if they wish, Arcyd
provides a zero-config layer over Git to get them started.

Arcyd does the following:
- watches for specially named branches and automatically creates revisions
- automatically updates revisions when the branch changes
- automatically lands revisions when they are approved

minimal user workflow:
    $ git checkout feature/mywork
    ~ commit some work on the branch ~
    $ git push origin feature/mywork:ph-review/mywork/master

    .. Arcyd see's the 'ph-review' branch and creates a review ..
    .. Reviewer accepts the change ..
    .. Arcyd squashes the 'ph-review' branch onto master and deletes it ..
        """)

    epilog = str("""
usage example:
    Using the example accounts baked into the 'phabricator-tools'
    vagrant/puppet installation. (see ./README)

    $ arcyd
    --system-admin-email systemadmin@server.test \\
    --sendmail-binary sendmail \\
    single \\
    --instance-uri https://127.0.0.1/api/ \\
    --arcyd-user phab \\
    --arcyd-cert xnh5tpatpfh4pff4tpnvdv74mh74zkmsualo4l6mx7bb262zqr55vcachxgz7\
ru3lrvafgzquzl3geyjxw426ujcyqdi2t4ktiv7gmrtlnc3hsy2eqsmhvgifn2vah2uidj6u6hhhxo\
2j3y2w6lcsehs2le4msd5xsn4f333udwvj6aowokq5l2llvfsl3efcucraawtvzw462q2sxmryg5y5\
rpicdk3lyr3uvot7fxrotwpi3ty2b2sa2kvlpf
    --arcyd-email phab-role-account@server.example \\
    --admin-email admin@server.example \\
    --repo-desc http://server.example/repo.git \\
    --sleep-duration 60

    You can also split the configuration across multiple files and combine them
    on the command-line or have them inherit from eachother.

    in localinstance.cfg:
        --instance-uri
        https://127.0.0.1/api/
        --arcyd-user
        phab
        --arcyd-cert
        <<paste-certificate-here>>

    in email.cfg:
        --arcyd-email
        phab-role-account@server.example
        --admin-email
        admin@server.example

    in repo1.cfg:
        --repo-desc
        http://server.example/repo.git
        --repo-path
        /path/to/repo

    to run arcyd:
    $ arcyd
    --system-admin-email systemadmin@server.test \\
    --sendmail-binary sendmail \\
    single @localinstance.cfg @email.cfg @repo1.cfg

    or you can use inheritance, e.g. in repo2.cfg:
        @localinstance.cfg
        @email.cfg
        --repo-desc
        http://server.example/repo2.git
        --repo-path
        /path/to/repo

    to run arcyd:
    $ arcyd
    --system-admin-email systemadmin@server.test \\
    --sendmail-binary sendmail \\
    single @localinstance.cfg @email.cfg @repo1.cfg
    """)

    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description=description,
        epilog=epilog)

    parser.add_argument(
        '--sys-admin-emails',
        metavar="EMAIL",
        nargs="+",
        type=str,
        required=True,
        help="email addresses to send important system events to")

    parser.add_argument(
        '--sendmail-binary',
        metavar="PROGRAM",
        type=str,
        default="sendmail",
        required=True,
        help="program to send the mail with (e.g. sendmail)")

    subparsers = parser.add_subparsers()

    setupParser("single", abdcmd_single, subparsers)
    setupParser("multi", abdcmd_multi, subparsers)

    args = parser.parse_args()

    sendmail = phlsys_sendmail.Sendmail(args.sendmail_binary)
    uname = str(platform.uname())
    sender = "arcyd@" + platform.node()

    mime = phlmail_format.Text(
        subject="arcyd started",
        message=uname,
        from_address=sender,
        to_addresses=args.sys_admin_emails)
    sendmail.send(mime)

    try:
        args.func(args)
    except Exception:
        message = uname + "\n" + traceback.format_exc()
        mime = phlmail_format.Text(
            subject="arcyd stopped with exception",
            message=message,
            from_address=sender,
            to_addresses=args.sys_admin_emails)
        sendmail.send(mime)


if __name__ == "__main__":
    sys.exit(main())

#------------------------------------------------------------------------------
# Copyright (C) 2012 Bloomberg L.P.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to
# deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
# sell copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# IN THE SOFTWARE.
#------------------------------- END-OF-FILE ----------------------------------
